name: Revert Label Changes

on:
  label:
    types: [created, deleted, edited]
    
permissions:
  contents: read
  issues: write
  pull-requests: write
  
jobs:
  revert_label_changes:
    runs-on: ubuntu-latest
    if: github.actor != 'Raul-Paiva'
    steps:
      - name: Verificar o Tipo de Ação e Capturar Dados de Reversão
        id: check_action
        uses: actions/github-script@v7 
        with:
          script: |
            const ACTION = context.payload.action;
            const LABEL_NAME = context.payload.label.name;
            console.log(`Ação: ${ACTION} na label: ${LABEL_NAME}`);

            let revertAction = '';
            let revertName = LABEL_NAME;
            let revertColor = context.payload.label.color;
            let revertDescription = context.payload.label.description || '';

            if (ACTION === 'created') {
              revertAction = 'delete';
            } else if (ACTION === 'deleted') {
              revertAction = 'create';
            } else if (ACTION === 'edited') {
              revertAction = 'edit';
              const OLD_NAME = context.payload.changes.name?.from;
              const OLD_COLOR = context.payload.changes.color?.from;
              const OLD_DESCRIPTION = context.payload.changes.description?.from;

              const changes = context.payload.changes;
              
              if (changes && changes.name) revertName = changes.name.from;
              if (changes && changes.color) revertColor = changes.color.from;
              if (changes && changes.description) revertDescription = changes.description.from;
            }
            
            // Define as saídas do passo
            core.setOutput('revert_action', revertAction);
            core.setOutput('revert_name', revertName);
            core.setOutput('revert_color', revertColor);
            core.setOutput('revert_description', revertDescription);
          result-encoding: json

      - name: Reverter Criação (Eliminar Label)
        if: steps.check_action.outputs.revert_action == 'delete'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const labelName = context.payload.label.name;
            console.log(`A reverter a criação: A eliminar a label "${labelName}"`);
            try {
              await github.rest.issues.deleteLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName
              });
              console.log(`Label "${labelName}" eliminada com sucesso.`);
            } catch (error) {
              core.warning(`Erro ao eliminar a label: ${error.message}`);
            }

      - name: Reverter Eliminação (Criar Label)
        if: steps.check_action.outputs.revert_action == 'create'
        uses: actions/github-script@v7
        env:
          LABEL_COLOR: ${{ steps.check_action.outputs.revert_color }}
          LABEL_DESCRIPTION: ${{ steps.check_action.outputs.revert_description }}
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const labelName = context.payload.label.name;
            const labelColor = process.env.LABEL_COLOR;
            const labelDescription = process.env.LABEL_DESCRIPTION;

            console.log(`A reverter a eliminação: A recriar a label "${labelName}"`);
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
                color: labelColor,
                description: labelDescription
              });
              console.log(`Label "${labelName}" recriada com sucesso.`);
            } catch (error) {
              core.warning(`Erro ao recriar a label: ${error.message}`);
            }

      - name: Reverter Edição (Atualizar Label)
        if: steps.check_action.outputs.revert_action == 'edit'
        uses: actions/github-script@v7
        env:
          REVERT_TO_NAME: ${{ steps.check_action.outputs.revert_name }}
          REVERT_TO_COLOR: ${{ steps.check_action.outputs.revert_color }}
          REVERT_TO_DESCRIPTION: ${{ steps.check_action.outputs.revert_description }}
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const currentLabelName = context.payload.label.name;
            const revertToName = process.env.REVERT_TO_NAME;
            const revertToColor = process.env.REVERT_TO_COLOR;
            const revertToDescription = process.env.REVERT_TO_DESCRIPTION;

            console.log(`A reverter edição. Nome atual: ${currentLabelName}. Reverter para nome: ${revertToName}, cor: ${revertToColor}`);
            try {
              await github.rest.issues.updateLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: currentLabelName, 
                new_name: revertToName, 
                color: revertToColor,
                description: revertToDescription
              });
              console.log(`Edição de label "${currentLabelName}" revertida com sucesso.`);
            } catch (error) {
              core.setFailed(`Falha ao reverter a edição da label: ${error.message}`);
            }
