name: Automatic Triage

# Triggers when a new Issue is opened
on:
  issues:
    types: [opened, reopened, transferred]
  pull_request:
    types: [opened, reopened]

# Permissions are CRUCIAL for this workflow
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auto_issues_triage:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Define Variables and IDs
        id: set_vars
        run: |

          # Your Organization Project ID
          echo "ORG_PROJECT_ID=PVT_kwDODrIVqM4BJ2wt" >> $GITHUB_ENV

          # 'Status' Field ID and the 'Pending' Value ID
          echo "STATUS_FIELD_ID=PVTSSF_lADODrIVqM4BJ2wtzg55V6w" >> $GITHUB_ENV
          echo "PENDING_VALUE_ID=98236657" >> $GITHUB_ENV

          # 'Priority' Field ID and the 'High' Value ID
          echo "PRIORITY_FIELD_ID=PVTSSF_lADODrIVqM4BJ2wtzg55V-I" >> $GITHUB_ENV
          echo "HIGH_VALUE_ID=5d69d15d" >> $GITHUB_ENV

          # ID of the Issue/PR that triggered the workflow
          echo "ISSUE_NODE_ID=${{ github.event.issue.node_id }}" >> $GITHUB_ENV

      - name: 1. Add Labels (status:pending, priority:high)
        uses: actions/github-script@v6
        with:
          script: |

            const issueNumber = context.issue.number;
            const labelsToAdd = ['status: pending', 'priority: high'];

            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labelsToRemove = currentLabels.map(label => label.name);
            
            if (labelsToRemove.length > 0) {
              console.log(`Current labels found: ${labelsToRemove.join(', ')}`);
          
              // 2. Remove each current label, one by one
              // The API does not have a single endpoint to remove ALL labels.
              for (const labelName of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: labelName
                  });
                  console.log(`Label removed: ${labelName}`);
                } catch (error) {
                  // Handle cases where the label might have already been removed
                  console.warn(`Warning: Could not remove ${labelName}.`);
                }
              }
              console.log(`All existing labels have been cleared.`);
            } else {
              console.log('No existing labels to remove. Proceeding.');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: labelsToAdd
            });
            console.log(`Labels added: ${labelsToAdd.join(', ')}`);

      - name: 2. Add Issue to Project and Set Fields (GraphQL)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |

            const issueNodeId = process.env.ISSUE_NODE_ID;
            const projectId = process.env.ORG_PROJECT_ID;
            const statusFieldId = process.env.STATUS_FIELD_ID;
            const pendingValueId = process.env.PENDING_VALUE_ID;
            const priorityFieldId = process.env.PRIORITY_FIELD_ID;
            const highValueId = process.env.HIGH_VALUE_ID;


            // 1. Add the Issue to the Project (This returns the projectItemId)
            const setFieldsMutation = `
              mutation($project: ID!, $content: ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                  item {
                    id
                  }
                }
              }
            `;

            
            const addedItem = await github.graphql(setFieldsMutation, {
              project: projectId,
              content: issueNodeId
            });


            const projectItemId = addedItem.addProjectV2ItemById.item.id;
            console.log(`Project Item ID retrieved: ${projectItemId}`);


            // 2. Set the Status Field
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}", 
                  itemId: "${projectItemId}", 
                  fieldId: "${statusFieldId}", 
                  value: { singleSelectOptionId: "${pendingValueId}" }
                }) { clientMutationId }
              }
            `);

            
            // 3. Set the Priority Field
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}", 
                  itemId: "${projectItemId}", 
                  fieldId: "${priorityFieldId}", 
                  value: { singleSelectOptionId: "${highValueId}" }
                }) { clientMutationId }
              }
            `);

            console.log("Status and Priority fields set successfully.");
            
  auto_pr_triage:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Define Variables and IDs (PR)
        id: set_vars_pr
        run: |

          # Your Organization Project ID
          echo "ORG_PROJECT_ID=PVT_kwDODrIVqM4BJ2wt" >> $GITHUB_ENV

          # 'Status' Field ID and the 'Under Review' Value ID
          echo "STATUS_FIELD_ID=PVTSSF_lADODrIVqM4BJ2wtzg55V6w" >> $GITHUB_ENV
          echo "REVIEW_VALUE_ID=f72a7aed" >> $GITHUB_ENV

          # 'Priority' Field ID and the 'High' Value ID
          echo "PRIORITY_FIELD_ID=PVTSSF_lADODrIVqM4BJ2wtzg55V-I" >> $GITHUB_ENV
          echo "HIGH_VALUE_ID=5d69d15d" >> $GITHUB_ENV

          # --- Obtém o ID do Node do Pull Request ---
          echo "NODE_ID=${{ github.event.pull_request.node_id }}" >> $GITHUB_ENV
  
      - name: 1. Add Labels (status:under review, priority:low)
        uses: actions/github-script@v6
        with:
          script: |
            // Obtém o número do Pull Request (usa context.issue.number para compatibilidade)
            const itemNumber = context.issue.number;
            const labelsToAdd = ['status: under review', 'priority: high'];

            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labelsToRemove = currentLabels.map(label => label.name);
            
            if (labelsToRemove.length > 0) {
              console.log(`Current labels found: ${labelsToRemove.join(', ')}`);
          
              // 2. Remove each current label, one by one
              // The API does not have a single endpoint to remove ALL labels.
              for (const labelName of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: labelName
                  });
                  console.log(`Label removed: ${labelName}`);
                } catch (error) {
                  // Handle cases where the label might have already been removed
                  console.warn(`Warning: Could not remove ${labelName}.`);
                }
              }
              console.log(`All existing labels have been cleared.`);
            } else {
              console.log('No existing labels to remove. Proceeding.');
            }
  
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: itemNumber,
              labels: labelsToAdd
            });
            console.log(`Labels added: ${labelsToAdd.join(', ')}`);
  
      - name: 2. Add Item to Project and Set Fields (GraphQL)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            // Usa NODE_ID do Pull Request
            const node_id = process.env.NODE_ID;
            const projectId = process.env.ORG_PROJECT_ID;
            const statusFieldId = process.env.STATUS_FIELD_ID;
            const reviewValueId = process.env.REVIEW_VALUE_ID;
            const priorityFieldId = process.env.PRIORITY_FIELD_ID;
            const highValueId = process.env.HIGH_VALUE_ID;
  
            // 1. Add the Item to the Project
            const setFieldsMutation = `
              mutation($project: ID!, $content: ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                  item { id }
                }
              }
            `;
              
            const addedItem = await github.graphql(setFieldsMutation, {
              project: projectId,
              content: node_id
            });
  
            const projectItemId = addedItem.addProjectV2ItemById.item.id;
            console.log(`Project Item ID retrieved: ${projectItemId}`);
  
            // 2. Set the Status Field
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}", 
                  itemId: "${projectItemId}", 
                  fieldId: "${statusFieldId}", 
                  value: { singleSelectOptionId: "${reviewValueId}" }
                }) { clientMutationId }
              }
            `);
  
            // 3. Set the Priority Field
            await github.graphql(`
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "${projectId}", 
                  itemId: "${projectItemId}", 
                  fieldId: "${priorityFieldId}", 
                  value: { singleSelectOptionId: "${highValueId}" }
                }) { clientMutationId }
              }
            `);
  
            console.log("Status and Priority fields set successfully.");
